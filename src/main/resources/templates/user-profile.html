<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
  <head>
    <meta charset="UTF-8">
    <title>User Profile</title>
    <link rel="stylesheet" type="text/css" th:href="@{/css/style.css}">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  </head>
  <body>
  <div th:replace="~{fragments/fragments :: header}"></div>
    <div class="profile-container">
      <h2>My Profile</h2>
      <form id="profileForm">
        <input type="hidden" id="id" th:value="${user.id}" />
        <label for="name">Name:</label>
        <input type="text" id="name" name="name" th:value="${user.name}" />
        <label for="surname">Surname:</label>
        <input type="text" id="surname" name="surname" th:value="${user.surname}" />
        <label for="birthdate">Birthdate:</label>
        <input type="date" id="birthdate" name="birthdate" th:value="${user.birthdate}" />
        <label for="address">Address:</label>
        <input type="text" id="address" name="address" th:value="${user.address}" />
        <label for="email">Email:</label>
        <input type="email" id="email" name="email" th:value="${user.email}" />
        <label for="username">Username:</label>
        <input type="text" id="username" name="username" th:value="${user.username}" required />
        <label for="password">Current Password:</label>
        <input type="password" id="password" name="password" required/>
        <label for="newPassword">New Password:</label>
        <input type="password" id="newPassword" name="newPassword" required />
        <label for="confirmNewPassword">Confirm New Password:</label>
        <input type="password" id="confirmNewPassword" name="confirmNewPassword" required />
        <button type="button" id="updateProfileButton">Update Profile</button>
      </form>
    </div>

    <div th:replace="~{fragments/fragments :: footer}"></div>
    <script>
        function updateProfile() {
            let userData = {
                id: $('#id').val(),
                name: $('#name').val(),
                surname: $('#surname').val(),
                birthdate: $('#birthdate').val(),
                address: $('#address').val(),
                email: $('#email').val(),
                username: $('#username').val(),
                password: $('#password').val(),
                newPassword: $('#newPassword').val(),
                confirmNewPassword: $('#confirmNewPassword').val()
            };

            if (userData.newPassword !== userData.confirmNewPassword) {
                alert('Passwords do not match.');
                return;
            }

            $.ajax({
                url: '/profile/update',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(userData),
                success: function(response) {
                    alert('Profile updated successfully');
                    $('#name').val(response.name);
                    $('#surname').val(response.surname);
                    $('#birthdate').val(response.birthdate);
                    $('#address').val(response.address);
                    $('#email').val(response.email);
                },

                error: function(response) {
                    let errorMessage = "Error during profile updating: ";
                    if (response.responseText) {
                        errorMessage += response.responseText;
                    } else {
                        errorMessage += "Unknown error";
                    }
                    alert(errorMessage);
                }
            });
        }

        $(document).ready(function() {
            $('#updateProfileButton').click(function(e) {
                e.preventDefault();
                updateProfile();
            });
        });
    </script>
  </body>
</html>
